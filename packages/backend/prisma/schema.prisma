// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  // 生产镜像基于 Debian slim，显式生成 OpenSSL 3.0 版本的二进制，避免回退到 1.1
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 1. 用户表
model User {
  id             Int      @id @default(autoincrement())
  username       String   @unique
  hashedPassword String
  role           String   @default("USER") // 'ADMIN' or 'USER'
  createdAt      DateTime @default(now())
  status         String   @default("ACTIVE") // 'PENDING' | 'ACTIVE' | 'DISABLED'
  approvedAt     DateTime?
  approvedById   Int?
  rejectedAt     DateTime?
  rejectedById   Int?
  rejectionReason String?
  preferredModelId       String?
  preferredConnectionId  Int?
  preferredModelRawId    String?
  avatarPath             String? @map("avatar_path")
  personalPrompt         String?

  chatSessions  ChatSession[]
  connections   Connection[]
  usageQuotas   UsageQuota[]
  chatShares    ChatShare[] @relation("UserChatShares")
  documents     Document[]

  @@index([status])
  @@map("users")
}

// 2. 聊天会话表
model ChatSession {
  id              Int       @id @default(autoincrement())
  userId          Int?
  anonymousKey    String?
  expiresAt       DateTime?
  // 连接为中心：使用 Connection + 原始模型ID
  connectionId    Int?
  modelRawId      String?   // 供应商原始模型ID（不含前缀）
  title           String    // 可由首条消息自动生成
  createdAt       DateTime  @default(now())
  // 可选置顶：非空表示置顶时间
  pinnedAt        DateTime?
  // 会话级推理默认：为空表示遵循系统设置
  reasoningEnabled Boolean?
  reasoningEffort  String?   // 'low' | 'medium' | 'high'
  ollamaThink      Boolean?
  // 会话级系统提示词：为空表示继承系统级
  systemPrompt     String?

  user        User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  connection  Connection?  @relation(fields: [connectionId], references: [id])
  messages    Message[]
  usageMetrics UsageMetric[]
  taskTraces  TaskTrace[]
  shares      ChatShare[]
  sessionDocuments SessionDocument[]

  @@index([expiresAt])
  @@index([anonymousKey])
  @@index([userId, pinnedAt])
  @@index([anonymousKey, pinnedAt])

  @@map("chat_sessions")
}

// 4. 消息记录表
model Message {
  id        Int      @id @default(autoincrement())
  sessionId Int
  parentMessageId Int?
  variantIndex Int? @default(1)
  role      String   // 'user' or 'assistant'
  content   String
  // 客户端生成的幂等ID（可选）。与 sessionId 组成唯一键，用于避免重复写入
  clientMessageId String?
  // 可选：保存推理(思维链)内容与持续时长（秒）。默认不启用保存，受系统设置控制。
  reasoning               String?
  reasoningDurationSeconds Int?
  toolLogsJson            String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  streamStatus String @default("done")
  streamCursor Int @default(0)
  streamReasoning String?
  streamError String?

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  attachments MessageAttachment[]
  usageMetrics UsageMetric[]
  taskTraces TaskTrace[]
  parent Message? @relation("MessageVariants", fields: [parentMessageId], references: [id])
  variants Message[] @relation("MessageVariants")

  // 若提供了 clientMessageId，则 (sessionId, clientMessageId) 必须唯一；
  // clientMessageId 为空时不受限（SQLite 下 NULL 不参与唯一比较）。
  @@unique([sessionId, clientMessageId])
  @@index([parentMessageId])
  @@map("messages")
}

model MessageAttachment {
  id           Int      @id @default(autoincrement())
  messageId    Int
  relativePath String
  createdAt    DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("message_attachments")
}

model ChatShare {
  id                     Int      @id @default(autoincrement())
  sessionId              Int
  token                  String   @unique
  title                  String
  messageIdsJson         String   @default("[]")
  payloadJson            String
  createdByUserId        Int?
  createdByAnonymousKey  String?
  createdAt              DateTime @default(now())
  expiresAt              DateTime?
  revokedAt              DateTime?

  session       ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  createdByUser User?       @relation("UserChatShares", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([createdByUserId])
  @@map("chat_shares")
}

// 3. 用量统计表（每轮生成一条，关联到 assistant 消息）
model UsageMetric {
  id               Int       @id @default(autoincrement())
  sessionId        Int
  messageId        Int?
  model            String
  provider         String?
  promptTokens     Int       @default(0)
  completionTokens Int       @default(0)
  totalTokens      Int       @default(0)
  firstTokenLatencyMs Int?
  responseTimeMs   Int?
  tokensPerSecond  Float?
  contextLimit     Int?
  createdAt        DateTime  @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  message Message?     @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([messageId])
  @@map("usage_metrics")
}

// 4. 系统设置表
model SystemSetting {
  key   String @id
  value String

  @@map("system_settings")
}

model UsageQuota {
  id               Int      @id @default(autoincrement())
  identifier       String
  scope            String
  customDailyLimit Int?     @map("dailyLimit")
  usedCount        Int      @default(0)
  lastResetAt      DateTime @default(now())
  userId           Int?

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([scope, identifier])
  @@index([userId])
  @@map("usage_quota")
}

// 5. 连接（系统或用户直连）
model Connection {
  id             Int       @id @default(autoincrement())
  ownerUserId    Int?      // null=系统级；非空=用户级直连
  provider       String    // 'openai' | 'azure_openai' | 'ollama'
  vendor         String?
  baseUrl        String
  enable         Boolean   @default(true)
  authType       String    @default("bearer") // 'bearer' | 'none' | 预留：'session' | 'system_oauth' | 'microsoft_entra_id'
  apiKey         String    @default("")      // 加密存储；none 时为空
  headersJson    String    @default("")      // 额外HTTP头（JSON字符串）
  azureApiVersion String?  // 仅 provider=azure_openai 时必填
  prefixId       String?
  tagsJson       String    @default("[]")
  modelIdsJson   String    @default("[]")
  defaultCapabilitiesJson String @default("{}")
  connectionType String    @default("external") // 'external' | 'local'
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  owner          User?     @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  sessions       ChatSession[]
  catalogs       ModelCatalog[]

  @@map("connections")
}

// 6. 模型目录缓存（由连接聚合生成）
model ModelCatalog {
  id             Int       @id @default(autoincrement())
  connectionId   Int
  modelId        String    // 对外展示ID（含 prefix）
  rawId          String    // 供应商原始ID（不含前缀）
  name           String
  provider       String
  connectionType String
  modelType      String    @default("chat") // 'chat' | 'embedding' | 'both'
  tagsJson       String    @default("[]")
  metaJson       String    @default("{}")
  capabilitiesJson String  @default("{}")
  manualOverride Boolean   @default(false)
  lastFetchedAt  DateTime  @default(now())
  expiresAt      DateTime

  connection     Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, modelId])
  @@index([connectionId])
  @@index([modelType])
  @@map("model_catalog")
}

model TaskTrace {
  id              Int       @id @default(autoincrement())
  sessionId       Int?
  messageId       Int?
  clientMessageId String?
  actor           String
  status          String    @default("running")
  traceLevel      String    @default("standard")
  metadata        String    @default("{}")
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  durationMs      Int?
  eventCount      Int       @default(0)
  logFilePath     String?

  session ChatSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  message Message?     @relation(fields: [messageId], references: [id], onDelete: SetNull)
  events  TaskTraceEvent[]
  latexTrace LatexTrace?

  @@index([sessionId])
  @@index([messageId])
  @@index([status])
  @@index([startedAt])
  @@map("task_traces")
}

model TaskTraceEvent {
  id        Int      @id @default(autoincrement())
  traceId   Int
  seq       Int
  eventType String
  payload   String
  timestamp DateTime @default(now())

  trace TaskTrace @relation(fields: [traceId], references: [id], onDelete: Cascade)

  @@unique([traceId, seq])
  @@index([traceId, timestamp])
  @@map("task_trace_events")
}

model LatexTrace {
  id              Int      @id @default(autoincrement())
  taskTraceId     Int      @unique @map("task_trace_id")
  matchedBlocks   Int      @default(0) @map("matched_blocks")
  unmatchedBlocks Int      @default(0) @map("unmatched_blocks")
  status          String   @default("pending")
  metadata        String   @default("{}")
  logFilePath     String?  @map("log_file_path")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  taskTrace TaskTrace @relation(fields: [taskTraceId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("latex_traces")
}

// ============================================
// 文档解析 (RAG) 相关模型
// ============================================

// 文档表 - 存储上传的文档元数据
model Document {
  id              Int       @id @default(autoincrement())
  userId          Int?
  anonymousKey    String?
  filename        String    // 存储文件名 (UUID.ext)
  originalName    String    // 原始文件名
  mimeType        String
  fileSize        Int       // 字节数
  filePath        String    // 存储路径
  status          String    @default("pending") // pending | processing | ready | error
  processingStage String?   @default("pending") // parsing | chunking | embedding | storing | done | error
  processingProgress Int    @default(0) // 0-100
  processingStartedAt DateTime?
  processingHeartbeatAt DateTime?
  processingFinishedAt DateTime?
  errorMessage    String?
  contentHash     String?   // 用于去重
  chunkCount      Int       @default(0)
  collectionName  String?   // 向量数据库 collection 名称
  metadata        String    @default("{}") // JSON: 页数、字数等
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  expiresAt       DateTime? // 自动清理时间
  lastAccessedAt  DateTime? // 最后访问时间
  accessCount     Int       @default(0)

  user             User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  chunks           DocumentChunk[]
  sessionDocuments SessionDocument[]
  processingJob    DocumentProcessingJob?

  @@index([userId])
  @@index([anonymousKey])
  @@index([status])
  @@index([expiresAt])
  @@index([contentHash])
  @@map("documents")
}

// 文档处理任务表 - Worker 队列
model DocumentProcessingJob {
  id          Int      @id @default(autoincrement())
  documentId  Int      @unique
  status      String   @default("pending") // pending | running | retrying | failed | canceled | done
  attempts    Int      @default(0)
  maxAttempts Int      @default(2)
  nextRunAt   DateTime?
  workerId    String?
  lockedAt    DateTime?
  lastError   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([nextRunAt])
  @@map("document_processing_jobs")
}

// 文档块表 - 存储分块后的文档内容
model DocumentChunk {
  id          Int      @id @default(autoincrement())
  documentId  Int
  chunkIndex  Int
  content     String
  tokenCount  Int      @default(0)
  metadata    String   @default("{}") // JSON: 页码、标题等
  vectorId    String?  // 向量数据库中的ID
  createdAt   DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, chunkIndex])
  @@index([documentId])
  @@map("document_chunks")
}

// 会话-文档关联表 (临时附加模式)
model SessionDocument {
  id         Int      @id @default(autoincrement())
  sessionId  Int
  documentId Int
  addedAt    DateTime @default(now())

  session  ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  document Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, documentId])
  @@index([sessionId])
  @@index([documentId])
  @@map("session_documents")
}
