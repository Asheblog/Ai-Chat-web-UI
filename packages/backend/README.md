# AI Chat Platform Backend

åŸºäº Hono æ¡†æ¶çš„è½»é‡çº§ AI èŠå¤©å¹³å°åç«¯æœåŠ¡ã€‚

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Hono (Node.js)
- **è¯­è¨€**: TypeScript
- **æ•°æ®åº“**: SQLite3 + Prisma ORM
- **è®¤è¯**: JWT (JSON Web Token)
- **åŠ å¯†**: bcryptjs (å¯†ç ) + crypto-js (API Key)

## åŠŸèƒ½ç‰¹æ€§

### ğŸ” ç”¨æˆ·è®¤è¯
- JWT æ— çŠ¶æ€è®¤è¯
- å¯†ç å®‰å…¨å“ˆå¸Œå­˜å‚¨
- æ”¯æŒå•ç”¨æˆ·/å¤šç”¨æˆ·æ¨¡å¼
- è§’è‰²æƒé™ç®¡ç† (ADMIN/USER)

### ğŸ¤– æ¨¡å‹ç®¡ç†
- ä¸ªäººæ¨¡å‹é…ç½®
- ç³»ç»Ÿæ¨¡å‹é…ç½® (ç®¡ç†å‘˜)
- API Key åŠ å¯†å­˜å‚¨
- æ¨¡å‹æƒé™æ§åˆ¶

### ğŸ’¬ èŠå¤©åŠŸèƒ½
- ä¼šè¯ç®¡ç†
- æ¶ˆæ¯å†å²è®°å½•
- åŸºäºTokençš„ä¸Šä¸‹æ–‡ç®¡ç†
- æµå¼å“åº” (SSE)
- ç¬¬ä¸‰æ–¹AIæ¨¡å‹ä»£ç†

### âš™ï¸ ç³»ç»Ÿè®¾ç½®
- ç³»ç»Ÿè®¾ç½®ç®¡ç† (ç®¡ç†å‘˜)
- ä¸ªäººè®¾ç½®é…ç½®
- å¥åº·æ£€æŸ¥æ¥å£
- åº”ç”¨ä¿¡æ¯æŸ¥è¯¢

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Node.js 18+
- npm æˆ– yarn

### å®‰è£…ä¾èµ–

```bash
npm install
```

### ç¯å¢ƒé…ç½®ï¼ˆé›†ä¸­åŒ–ï¼‰

æ¨èä½¿ç”¨ä»“åº“æ ¹ç›®å½•çš„ç¯å¢ƒæ–‡ä»¶é›†ä¸­ç®¡ç†ï¼š

- å¤åˆ¶æ ¹æ¨¡æ¿ï¼š`cp .env.example .env`ï¼ˆåœ¨ä»“åº“æ ¹ç›®å½•ï¼‰
- é€šè¿‡ `docker-compose.dev.yml` / `docker-compose.yml` å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨è¯»å–æ ¹ `.env`

å¦‚éœ€â€œå•ç‹¬åœ¨æ­¤ç›®å½•å¼€å‘åç«¯ä¸”ä¸é€šè¿‡ docker-compose å¯åŠ¨â€ï¼Œå¯ä»¥åœ¨æœ¬ç›®å½•åˆ›å»º `.env` ä¸´æ—¶è¦†ç›–å°‘é‡å˜é‡ï¼ˆå¯é€‰ï¼‰ã€‚
ä¸è·¨åŸŸç›¸å…³çš„å˜é‡ï¼š
- `ENABLE_CORS`ï¼ˆé»˜è®¤ `true`ï¼Œè®¾ä¸º `false` å°†å®Œå…¨å…³é—­ CORS ä¸­é—´ä»¶ï¼‰
- `CORS_ORIGIN`ï¼ˆå…è®¸çš„å‰ç«¯åœ°å€ï¼›ä¸ºç©ºæ—¶ä¸º `*`ï¼Œæ­¤æ—¶è‡ªåŠ¨ç¦ç”¨ credentialsï¼‰
å¦åˆ™è¯·ä¸è¦åœ¨åŒ…å†…ç»´æŠ¤ç‹¬ç«‹çš„ `.env`ï¼Œä»¥é¿å…é…ç½®æ¼‚ç§»ã€‚

### æ•°æ®åº“åˆå§‹åŒ–

```bash
# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
npm run db:generate

# æ¨é€æ•°æ®åº“æ¶æ„
npm run db:push

# (å¯é€‰) æŸ¥çœ‹æ•°æ®åº“
npm run db:studio
```

### å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
npm run dev
```

æœåŠ¡å™¨å°†åœ¨ `http://localhost:3001` å¯åŠ¨ã€‚

## API æ–‡æ¡£

### è®¤è¯æ¥å£

- `POST /api/auth/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /api/auth/login` - ç”¨æˆ·ç™»å½•
- `GET /api/auth/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- `PUT /api/auth/password` - ä¿®æ”¹å¯†ç 

### æ¨¡å‹ç®¡ç†

- `GET /api/models` - è·å–æ¨¡å‹é…ç½®åˆ—è¡¨
- `POST /api/models` - åˆ›å»ºä¸ªäººæ¨¡å‹é…ç½®
- `GET /api/models/:id` - è·å–æ¨¡å‹é…ç½®è¯¦æƒ…
- `PUT /api/models/:id` - æ›´æ–°æ¨¡å‹é…ç½®
- `DELETE /api/models/:id` - åˆ é™¤æ¨¡å‹é…ç½®
- `POST /api/models/system` - åˆ›å»ºç³»ç»Ÿæ¨¡å‹é…ç½® (ç®¡ç†å‘˜)

### ä¼šè¯ç®¡ç†

- `GET /api/sessions` - è·å–ä¼šè¯åˆ—è¡¨
- `POST /api/sessions` - åˆ›å»ºæ–°ä¼šè¯
- `GET /api/sessions/:id` - è·å–ä¼šè¯è¯¦æƒ…
- `PUT /api/sessions/:id` - æ›´æ–°ä¼šè¯æ ‡é¢˜
- `DELETE /api/sessions/:id` - åˆ é™¤ä¼šè¯

### èŠå¤©åŠŸèƒ½

- `POST /api/chat/stream` - å‘é€æ¶ˆæ¯ (æµå¼å“åº”)
- `POST /api/chat/completion` - å‘é€æ¶ˆæ¯ (éæµå¼å“åº”)
- `POST /api/chat/stop` - åœæ­¢ç”Ÿæˆ
- `POST /api/chat/regenerate` - é‡æ–°ç”Ÿæˆå›å¤

#### ç”¨é‡èšåˆæŸ¥è¯¢

- `GET /api/chat/usage?sessionId={id}` - è¿”å›ä¼šè¯ç»´åº¦çš„ç”¨é‡ç»Ÿè®¡ï¼š
  - `totals`: ç´¯è®¡ `prompt_tokens/completion_tokens/total_tokens`
  - `last_round`: æœ€è¿‘ä¸€è½®ç”¨é‡ï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œå« `prompt_tokens/completion_tokens/total_tokens/context_limit/createdAt/model/provider`
  - `current`: å³æ—¶ä¸Šä¸‹æ–‡å ç”¨ï¼ˆä¼°ç®—ï¼‰`prompt_tokens/context_limit/context_remaining`

#### æµå¼å“åº”ï¼ˆSSEï¼‰äº‹ä»¶ç±»å‹

æœåŠ¡ç«¯é€šè¿‡ `text/event-stream` æ¨é€ä»¥ä¸‹äº‹ä»¶ï¼š

- `start`ï¼šå¼€å§‹ç”Ÿæˆï¼ŒåŒ…å« `messageId`
- `content`ï¼šå¢é‡å†…å®¹ç‰‡æ®µï¼ˆdeltaï¼‰
- `usage`ï¼šç”¨é‡ç»Ÿè®¡äº‹ä»¶ï¼ˆOpenAI å…¼å®¹å­—æ®µï¼‰ã€‚ç¤ºä¾‹ï¼š
  - `{ "type": "usage", "usage": { "prompt_tokens": 123, "completion_tokens": 45, "total_tokens": 168, "context_limit": 4000, "context_remaining": 3877 } }`
  - è‹¥ä¸Šæ¸¸å‚å•†åœ¨æµä¸­è¿”å› `usage` å­—æ®µï¼Œä¼šè¢«åŸæ ·é€å‡ºï¼›å¦åˆ™åœ¨å¼€å§‹æ—¶å‘é€ä¸€æ¬¡åŸºäºä¸Šä¸‹æ–‡ä¼°ç®—çš„ `usage`ï¼Œåœ¨ç»“æŸå‰è¡¥é½ `completion_tokens` ä¸ `total_tokens`ï¼ˆä¼°ç®—ï¼‰ã€‚
- `end`ï¼šä¸Šæ¸¸æµç»“æŸï¼ˆå¦‚æ”¶åˆ° `[DONE]`ï¼‰
- `complete`ï¼šæœåŠ¡ç«¯å®Œæˆæ”¶å°¾
- `stop`ï¼šå¯é€‰çš„ç»“æŸåŸå› ï¼ˆå¦‚ `finish_reason`ï¼‰

#### ç½‘ç»œç¨³å®šæ€§ä¸é™çº§

- å¿ƒè·³ä¿æ´»ï¼šæœåŠ¡ç«¯æ¯éš”å›ºå®šæ—¶é—´ï¼ˆé»˜è®¤ 15sï¼‰æ¨é€ `: ping` æ³¨é‡Šå¸§ï¼Œé¿å…ä»£ç†ç©ºé—²æ–­å¼€ã€‚
- ä¸Šæ¸¸é€€é¿ï¼š
  - 429 â†’ é€€é¿ 15s åé‡è¯• 1 æ¬¡
  - 5xx/è¶…æ—¶ â†’ é€€é¿ 2s åé‡è¯• 1 æ¬¡
- æœ€å¤§ç©ºé—²ï¼šè‹¥ä¸Šæ¸¸æµåœ¨é˜ˆå€¼ï¼ˆé»˜è®¤ 60sï¼‰å†…æ— æ•°æ®ï¼Œä¸»åŠ¨ä¸­æ­¢æœ¬æ¬¡è¿æ¥ã€‚
- è‡ªåŠ¨é™çº§ï¼šæµå¼å¤±è´¥ä¸”å°šæœªè¾“å‡ºå†…å®¹æ—¶ï¼Œä¼šè‡ªåŠ¨æ”¹èµ°ä¸€æ¬¡éæµå¼è¯·æ±‚å¹¶è¿”å›å®Œæ•´æ–‡æœ¬ã€‚

å¯é…ç½®ç¯å¢ƒå˜é‡ï¼š

- `SSE_HEARTBEAT_INTERVAL_MS`ï¼ˆé»˜è®¤ 15000ï¼‰SSE å¿ƒè·³é—´éš”ï¼ˆæ¯«ç§’ï¼‰
- `PROVIDER_MAX_IDLE_MS`ï¼ˆé»˜è®¤ 60000ï¼‰ä¸Šæ¸¸æœ€å¤§ç©ºé—²æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
- `PROVIDER_TIMEOUT_MS`ï¼ˆé»˜è®¤ 300000ï¼‰ä¸Šæ¸¸è¯·æ±‚æ€»ä½“è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰

#### Usage ç»Ÿè®¡ä¸ç¯å¢ƒå˜é‡

- ç»Ÿè®¡é€»è¾‘
  - `prompt_tokens`ï¼šåŸºäº `Tokenizer.countConversationTokens` å¯¹æœ¬è½®ä¸Šä¸‹æ–‡ï¼ˆå†å²+å½“å‰ï¼‰è¿›è¡Œä¼°ç®—ï¼›
  - `completion_tokens`ï¼šåŸºäº `Tokenizer.countTokens` å¯¹ç”Ÿæˆç»“æœè¿›è¡Œä¼°ç®—ï¼›
  - å½“ä¸Šæ¸¸å‚å•†åœ¨æµå¼æ•°æ®ä¸­æä¾› `usage` å­—æ®µæ—¶ï¼ŒæœåŠ¡ç«¯ä¼šä¼˜å…ˆé€ä¼ å‚å•†ç»Ÿè®¡ç»“æœã€‚

- ç¯å¢ƒå˜é‡
  - `USAGE_EMIT`ï¼ˆé»˜è®¤ `true`ï¼‰ï¼šæ˜¯å¦å‘é€ `usage` äº‹ä»¶ï¼›
  - `USAGE_PROVIDER_ONLY`ï¼ˆé»˜è®¤ `false`ï¼‰ï¼šæ˜¯å¦ä»…é€ä¼ å‚å•† `usage`ï¼ˆä¸å‘é€æœ¬åœ°ä¼°ç®—ï¼‰ã€‚
  - `TOKENIZER_MODE`ï¼ˆ`precise`|`heuristic`ï¼Œé»˜è®¤ `precise`ï¼‰ï¼šæ˜¯å¦å¯ç”¨ç²¾ç¡®åˆ†è¯ï¼ˆä¾èµ– `gpt-tokenizer`ï¼‰ï¼Œå¤±è´¥æˆ–å…³é—­æ—¶å›é€€å¯å‘å¼ä¼°ç®—ã€‚

> æ³¨æ„ï¼šä¼°ç®—æ–¹æ³•ä¸ºå¯å‘å¼ï¼Œä¸­æ–‡/å¤šæ¨¡æ€å­˜åœ¨åå·®ï¼›éœ€é«˜ç²¾åº¦å¯æ¥å…¥æ¨¡å‹å¯¹åº”åˆ†è¯å™¨å¹¶æ›¿æ¢ `Tokenizer` å®ç°ã€‚

### ç³»ç»Ÿè®¾ç½®

- `GET /api/settings/system` - è·å–ç³»ç»Ÿè®¾ç½® (ç®¡ç†å‘˜)
- `PUT /api/settings/system` - æ›´æ–°ç³»ç»Ÿè®¾ç½® (ç®¡ç†å‘˜)
- `GET /api/settings/personal` - è·å–ä¸ªäººè®¾ç½®
- `GET /api/settings/health` - å¥åº·æ£€æŸ¥

## é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ api/           # API è·¯ç”±
â”‚   â”œâ”€â”€ auth.ts    # è®¤è¯ç›¸å…³
â”‚   â”œâ”€â”€ users.ts   # ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ models.ts  # æ¨¡å‹é…ç½®
â”‚   â”œâ”€â”€ sessions.ts # ä¼šè¯ç®¡ç†
â”‚   â”œâ”€â”€ chat.ts    # èŠå¤©åŠŸèƒ½
â”‚   â””â”€â”€ settings.ts # ç³»ç»Ÿè®¾ç½®
â”œâ”€â”€ db/            # æ•°æ®åº“
â”‚   â””â”€â”€ index.ts   # Prisma å®¢æˆ·ç«¯
â”œâ”€â”€ middleware/    # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ auth.ts    # è®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ error.ts   # é”™è¯¯å¤„ç†
â”œâ”€â”€ utils/         # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ auth.ts    # è®¤è¯å·¥å…·
â”‚   â””â”€â”€ tokenizer.ts # Token è®¡ç®—å™¨
â”œâ”€â”€ types/         # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ index.ts
â””â”€â”€ index.ts       # åº”ç”¨å…¥å£
```

## Docker éƒ¨ç½²

### æ„å»ºé•œåƒ

```bash
# ç”Ÿäº§ç¯å¢ƒæ„å»º
docker build -t aichat-backend .

# å¼€å‘ç¯å¢ƒæ„å»º
docker build --target development -t aichat-backend:dev .
```

### è¿è¡Œå®¹å™¨

```bash
# ç”Ÿäº§ç¯å¢ƒ
docker run -d \
  --name aichat-backend \
  -p 3001:3001 \
  -v $(pwd)/data:/app/data \
  --env-file .env \
  aichat-backend

# å¼€å‘ç¯å¢ƒ
docker run -it \
  --name aichat-backend-dev \
  -p 3001:3001 \
  -v $(pwd):/app \
  --env-file .env \
  aichat-backend:dev
```

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„APIç«¯ç‚¹

1. åœ¨ `src/api/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„è·¯ç”±æ–‡ä»¶
2. åœ¨ `src/index.ts` ä¸­æ³¨å†Œè·¯ç”±
3. åœ¨ `src/types/index.ts` ä¸­æ·»åŠ ç›¸å…³ç±»å‹å®šä¹‰
4. ç¼–å†™æµ‹è¯•ç”¨ä¾‹

### æ•°æ®åº“å˜æ›´

1. ä¿®æ”¹ `prisma/schema.prisma`
2. è¿è¡Œ `npm run db:generate` æ›´æ–°å®¢æˆ·ç«¯
3. è¿è¡Œ `npm run db:push` åº”ç”¨å˜æ›´
4. ï¼ˆå¯é€‰ï¼‰åˆ›å»ºè¿ç§»æ–‡ä»¶ `npm run db:migrate`

### é”™è¯¯å¤„ç†

æ‰€æœ‰APIéƒ½éµå¾ªç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼ï¼š

```json
{
  "success": false,
  "error": "é”™è¯¯ä¿¡æ¯",
  "data": null
}
```

## æ€§èƒ½ä¼˜åŒ–

- **å†…å­˜å ç”¨**: è®¾è®¡ç›®æ ‡ < 500MB
- **å“åº”æ—¶é—´**: API å¤„ç†æ—¶é—´ < 100ms
- **æ•°æ®åº“**: ä½¿ç”¨ SQLite3ï¼Œé›¶é…ç½®
- **å¹¶å‘å¤„ç†**: æ”¯æŒ SSE æµå¼å“åº”

## å®‰å…¨ç‰¹æ€§

- JWT Token è®¤è¯
- å¯†ç  bcrypt å“ˆå¸Œ
- API Key AES åŠ å¯†å­˜å‚¨
- CORS è·¨åŸŸä¿æŠ¤
- è¾“å…¥éªŒè¯å’Œæ¸…ç†
- SQL æ³¨å…¥é˜²æŠ¤ (Prisma ORM)

## è®¸å¯è¯

MIT License
