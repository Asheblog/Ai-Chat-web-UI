# 解耦计划

## 背景与目标
- 当前 `packages/frontend/src` 共 149 个 TS/TSX 文件，平均约 158 行；`store` 目录均值 483 行，`chat-store.ts` 达 2759 行，`lib/api.ts` 1194 行，多个组件（`welcome-screen.tsx`、`use-chat-composer.ts`、`message-bubble.tsx` 等）超 500 行。
- 数据访问、状态管理、界面逻辑紧耦合，跨模块直接引用 `apiClient` 与其他 store，导致渲染放大、复用困难、难以单测。
- 目标是在不强求向后兼容的前提下，拆解前端数据/状态/视图层，控制单文件体量，并为 Linux/Windows 双环境提供可复用、可替换的模块边界。

## 现状评估摘要
| 热点 | 行数 | 耦合表现 |
| --- | --- | --- |
| `packages/frontend/src/store/chat-store.ts` | 2759 | 集中所有会话、消息、流式、分享、usage、工具事件逻辑，直接依赖多个 store 与 `apiClient`。 |
| `packages/frontend/src/lib/api.ts` | 1194 | 单个 Axios 包装涵盖 auth/chat/settings/share/system 等所有 API，难以按域配置拦截器。 |
| `packages/frontend/src/components/welcome-screen.tsx` | 791 | 组件内处理文件上传、模型选择、Quota、复杂表单，复用性差。 |
| `packages/frontend/src/hooks/use-chat-composer.ts` | 737 | 与欢迎页重复的图片、请求体、特性开关逻辑。 |
| `packages/frontend/src/components/message-bubble.tsx` | 584 | 同时负责 Markdown 渲染、推理折叠、工具事件汇总、分享选取。 |

## 解耦策略
### 1. 数据层分域
- 在 `packages/frontend/src/features/<domain>/api.ts` 下按领域划分 API（chat/auth/settings/share/system 等），`lib/api.ts` 退化为 Axios 工厂与通用拦截器，抽出 `handleUnauthorized`、日志、中断控制。
- `services` 目录逐步迁到对应 `features/*/services.ts`，仅承载领域业务聚合； store/hook 不直接依赖 `apiClient`。
- Windows/Linux 兼容：所有 API 使用同一 Axios 工厂（统一超时、withCredentials），通过环境变量/配置切换基地址。

### 2. 状态层切片
- 以 `zustand` slice 形式拆出 `sessionSlice`、`messageSlice`、`streamSlice`、`usageSlice`、`shareSlice`：  
  - `sessionSlice`：拉取/创建/删除/切换会话、模型切换。  
  - `messageSlice`：`messageMetas`、`messageBodies`、渲染缓存、图片缓存。  
  - `streamSlice`：`activeStreams`、快照、poller、持久化逻辑。  
  - `usageSlice`：会话用量与 `sessionUsageTotalsMap`。  
  - `shareSlice`：分享选择态与分享相关 API。  
- 暴露 `useChatSessions`, `useChatMessages`, `useChatStreaming` 等 selector hook，UI 仅订阅必要字段，减少重渲染。
- 横切逻辑（tool events、snapshot）迁至 `features/chat/streaming/*` 独立模块，保持 `chat-store` 主文件 <350 行。

### 3. 视图层拆分与 ViewModel
- 新建 `features/chat/composer`：封装图片校验、blend 请求体/头缓存、思考模式 & 工具开关逻辑，供欢迎页与聊天 composer 共用。
- `WelcomeScreen` 拆为 `WelcomeHero`、`WelcomeForm`、`AdvancedOptions`、`ImagePreviewList` 等子组件，业务状态由 `useWelcomeScreenViewModel` 提供。
- `MessageBubble` 分解出 `MessageHeader`, `MessageBodyContent`, `ReasoningSection`, `ToolEventTimeline`, `ShareBadge`，并引入 `useToolTimeline` 共享 hook。
- Settings 页面按页划分 feature 目录(`features/settings/pages/system-general` 等)，页面组件保持 <250 行。
- `lib/animations.ts` 拆分为多文件（`page.ts`, `chat.ts`, `sidebar.ts` 等），按需 tree-shake。

### 4. 横切能力模块化
- 工具事件处理放入 `features/chat/tool-events`，提供 `useToolTimeline(metaId)`。
- 分享选择逻辑迁到 `features/share/selection-store.ts`，多个页面共享。
- Markdown worker 客户端继续保持隔离，必要时扩展 API 供新组件使用。

## 行数控制策略
- 目标：普通组件/服务 ≤250 行；复杂 store slice ≤350 行；整体平均行数降至 ≤130。
- 新增 `scripts/check-lines.mts`（Node/TS 可跨 Linux/Windows 运行）扫描 `packages/frontend/src/**/*.{ts,tsx}`，对单文件超限/平均值超限直接 `exit(1)`。
- `package.json` 增加 `lint:lines` 脚本，CI/本地在 `lint` 阶段执行；对仍在迁移的 legacy 文件使用白名单，并在 PR 中记录“免检到期”。
- ESLint 自定义 `max-lines`、`max-lines-per-function` 规则，覆盖 `features/**/components` 与 `features/**/stores`。
- PR 模板新增检查项：“新增或修改文件 >250 行须附拆分计划或说明原因”。

## 分步执行清单（按顺序勾选推进）
> 规则：除“并行”标注的子任务外，必须在完成并勾选前序任务后方可开始下一项。

### 阶段一：准备期（约 1 周）
- [x] 确认负责人与里程碑（前端负责：Codex，目标 1 周内完成阶段一），建立每日同步机制，并在 README 加入计划链接。
- [x] 在 `packages/frontend/src/features` 建立基础目录结构（chat/settings/share/system/auth），提交 scaffold 与 README。
- [x] 提炼 Axios 工厂：  
  - [x] 创建 `lib/http/client.ts`，封装 baseURL/timeout/withCredentials。  
  - [x] 拆出 `lib/http/interceptors.ts`，迁移日志与 401 处理逻辑。
- [x] 为每个领域新增占位 API 文件（`features/<domain>/api.ts`），仅导出类型与 TODO，并在旧 `apiClient` 中引用新模块（并行可进行）。
- [x] 引入 `scripts/check-lines.mts` 与 `lint:lines` 脚本，CI 中预先允许 whitelist。
- [x] 更新 ESLint 配置与 PR 模板，加入行数约束提示。

### 阶段二：核心拆分期（约 2–3 周）
- [x] **chat store 切片化（P0 / 第 1–1.5 周完成）**  
  - [x] 建立 `features/chat/store` 目录骨架：`types.ts`、`slices/{session,message,stream,usage,share}.ts`、公共 `utils`，并在 `@/store/chat-store.ts` 中仅 re-export。  
  - [x] `sessionSlice + usageSlice`：迁移会话 CRUD、模型切换、会话/全局 usage API，补充 `stopAllMessagePollers` 等共享方法，新增 `vitest` 针对 `fetchSessions` 与 `updateSessionPrefs` 的最小单测。  
  - [x] `messageSlice + shareSlice`：迁移 message/meta/render cache、share selection，暴露 `useChatSessions/useChatMessages` selector hook，更新 `message-list.tsx`、`share-dialog.tsx` 引用路径并完成回归测试。  
- [x] `streamSlice`：拆出 activeStreams、snapshots、poller/stopStreaming 逻辑，与 `messageSlice` 通过显式回调衔接；完成 streaming happy-path + cancel-path 单测。  
  - [x] 清理 legacy `chat-store.ts` 冗余段落，使入口 <350 行，并运行 `pnpm --filter @aichat/frontend test && pnpm --filter @aichat/frontend lint` 记录结果。
- [x] **视图共享逻辑（P0 / 第 1.5–2 周）**  
  - [x] Composer 统一：在 `features/chat/composer` 实现 `useImageAttachments`、`useAdvancedRequest`、`useComposerFeatureFlags`，这里处理图片压缩、header 校验、feature flag 缓存，并添加 `vitest` hook 单测。  
- [x] 更新 `hooks/use-chat-composer.ts` 与 `components/chat/chat-composer-panel.tsx`，统一引用上述 hook；为聊天主流程跑一次 `vitest --runInBand`。
  - [x] 欢迎页：抽象 `useWelcomeScreenViewModel`，创建 `welcome/WelcomeHero.tsx`、`WelcomeForm.tsx`、`AdvancedOptions.tsx`、`ImagePreviewList.tsx` 等组件，主文件仅负责组合；补一组 RTL smoke test。  
- [x] 消息气泡：拆分 `MessageHeader/MessageBodyContent/ReasoningSection/ToolTimeline/ShareBadge`，引入 memo selector，确保单个文件 <250 行。  
-  - [x] Settings：建立 `features/settings/pages/{system-general,system-models}`，迁移逻辑并补充快照测试，验证跨平台（Windows/Linux）路径引用无误。
- [ ] **工具与动画模块化（与上一步可并行）**  
  - [x] 创建 `features/chat/tool-events/useToolTimeline.ts`，整合 tool event/stream 状态，更新 `message-bubble`、`share-dialog`、`chat-message-viewport` 等调用。  
  - [x] 为工具事件补充 `vitest` 单测（start/result/error）以及可视化组件 story 校验。  
  - [x] 将 `lib/animations.ts` 拆分为 `lib/animations/{page,chat,sidebar}.ts`，并提供顶层 `index.ts` 统一导出；同步更新引用（Next layout、sidebar 等）。  
  - [x] 检查 Windows bat / Linux sh 构建脚本是否仍引用旧动画路径，必要时同步（确认无引用）。  
- [ ] **行数与质量闸**  
  - [x] 任务收尾前运行 `pnpm lint:lines`，剔除已完成模块的 whitelist；整理剩余超限清单并登记在 issue/PR 描述。（当前仍有 `lib/api.ts`、`features/chat/store/*`、`features/settings/pages/system-{general,models}.tsx` 等 20 个文件超限，详见命令输出，需后续拆分）  
  - [x] 对新建 slice/hook/组件补充 `README` 或内联使用说明，确保后续成员可直接接手。

### 阶段三：收尾与优化期（约 1–2 周）
- [ ] 彻底迁移 `lib/api.ts`，仅保留 Axios 工厂，其余 API 均移至 `features` 目录。
- [ ] 清理遗留的旧引用（直接使用 `apiClient`、legacy store 字段），确保导入路径统一。
- [ ] 覆盖剩余大文件（如 animations 以外的组件、hooks），按照行数目标继续拆分。
- [ ] 在 `README.md` 与内部文档中更新新的目录结构、脚本运行方式。
- [ ] 观察 `lint:lines` 结果：若平均行数仍 >130，列出未达标文件并制定后续计划。
- [ ] 整体复盘：记录拆分收益、性能指标、待办项，输出复盘纪要。

## 风险与对策
- **迁移期间 API 双写风险**：采用“新模块 + 旧调用”并行方式，逐步替换并借助 TypeScript 类型确保覆盖；必要时通过 `feature flag` 控制调用路径。
- **状态切片导致的行为回归**：为关键 slice 补充 `vitest` + `react-testing-library` 组件测试，尤其是 streaming 与 share 功能。
- **行数脚本误报**：保留 `--whitelist <glob>` 参数，供迁移期使用；脚本输出必须附文件行数，有助 Review。

## 输出与同步
- 本文档位于仓库根目录，随 PR 一并提交；在后续 PR 中引用对应章节，确保团队对拆分目标与顺序一致。
