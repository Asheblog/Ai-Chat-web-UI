version: '3.8'

services:
  backend:
    image: ghcr.io/asheblog/aichat-backend:latest
    container_name: ai-chat-web-ui-backend
    environment:
      - NODE_ENV=production
      - PORT=8001
      - DATABASE_URL=file:/app/data/app.db
      - JWT_SECRET=${JWT_SECRET:-replace-with-strong-secret}
      - DEFAULT_CONTEXT_TOKEN_LIMIT=${DEFAULT_CONTEXT_TOKEN_LIMIT:-120000}
      - ENABLE_CORS=${ENABLE_CORS:-false}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DB_INIT_ON_START=${DB_INIT_ON_START:-false}
      - PYTHON_RUNTIME_RECONCILE_ON_START=${PYTHON_RUNTIME_RECONCILE_ON_START:-true}
      - SKILL_STORAGE_ROOT=/app/data/skills
      - WORKSPACE_TOOL_ENABLE=${WORKSPACE_TOOL_ENABLE:-true}
      - WORKSPACE_ROOT_DIR=${WORKSPACE_ROOT_DIR:-/app/data/workspaces/chat}
      - WORKSPACE_ARTIFACT_TTL_MINUTES=${WORKSPACE_ARTIFACT_TTL_MINUTES:-60}
      - WORKSPACE_IDLE_TTL_MINUTES=${WORKSPACE_IDLE_TTL_MINUTES:-1440}
      - WORKSPACE_CLEANUP_INTERVAL_MINUTES=${WORKSPACE_CLEANUP_INTERVAL_MINUTES:-5}
      - WORKSPACE_MAX_BYTES=${WORKSPACE_MAX_BYTES:-1073741824}
      - WORKSPACE_ARTIFACT_MAX_BYTES=${WORKSPACE_ARTIFACT_MAX_BYTES:-104857600}
      - WORKSPACE_MAX_ARTIFACTS_PER_MESSAGE=${WORKSPACE_MAX_ARTIFACTS_PER_MESSAGE:-20}
      - WORKSPACE_RUN_TIMEOUT_MS=${WORKSPACE_RUN_TIMEOUT_MS:-120000}
      - WORKSPACE_RUN_NETWORK_MODE=${WORKSPACE_RUN_NETWORK_MODE:-none}
      - WORKSPACE_DOCKER_IMAGE=${WORKSPACE_DOCKER_IMAGE:-python:3.11-slim}
      - WORKSPACE_DOCKER_CPUS=${WORKSPACE_DOCKER_CPUS:-1.0}
      - WORKSPACE_DOCKER_MEMORY=${WORKSPACE_DOCKER_MEMORY:-1g}
      - WORKSPACE_DOCKER_PIDS_LIMIT=${WORKSPACE_DOCKER_PIDS_LIMIT:-256}
      - WORKSPACE_ARTIFACT_SIGNING_SECRET=${WORKSPACE_ARTIFACT_SIGNING_SECRET:-replace-with-strong-secret}
      - WORKSPACE_LIST_MAX_ENTRIES=${WORKSPACE_LIST_MAX_ENTRIES:-500}
      - WORKSPACE_READ_MAX_CHARS=${WORKSPACE_READ_MAX_CHARS:-120000}
      - WORKSPACE_GIT_CLONE_TIMEOUT_MS=${WORKSPACE_GIT_CLONE_TIMEOUT_MS:-120000}
      - WORKSPACE_PYTHON_INSTALL_TIMEOUT_MS=${WORKSPACE_PYTHON_INSTALL_TIMEOUT_MS:-300000}
    volumes:
      - backend_data:/app/data
      - backend_logs:/app/logs
      - backend_images:/app/storage/chat-images
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "${BACKEND_PORT:-8001}:8001"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8001/api/settings/health > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      ai-chat-web-ui-network:
        aliases:
          - backend

  rag-worker:
    image: ghcr.io/asheblog/aichat-backend:latest
    container_name: ai-chat-web-ui-rag-worker
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:/app/data/app.db
      - JWT_SECRET=${JWT_SECRET:-replace-with-strong-secret}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - NODE_OPTIONS=--max-old-space-size=1024
    volumes:
      - backend_data:/app/data
      - backend_logs:/app/logs
      - backend_images:/app/storage/chat-images
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - ai-chat-web-ui-network
    working_dir: /app/packages/backend
    command: ["node", "dist/workers/document-worker.js"]

  frontend:
    image: ghcr.io/asheblog/aichat-frontend:latest
    container_name: ai-chat-web-ui-frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=/api
      - BACKEND_HOST=backend
      - BACKEND_INTERNAL_PORT=8001
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ai-chat-web-ui-network

volumes:
  backend_data:
    driver: local
    name: ai_chat_web_ui_db_data
  backend_logs:
    driver: local
    name: ai_chat_web_ui_logs
  backend_images:
    driver: local
    name: ai_chat_web_ui_images

networks:
  ai-chat-web-ui-network:
    driver: bridge
    name: ai_chat_web_ui_network
